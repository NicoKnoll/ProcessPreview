<?php

/**
 * ProcessPreview
 *
 * By Nico Knoll (http://www.nico-knoll.de/)
 *
 */

class ProcessPreview extends Process implements Module {

	public static function getModuleInfo() {
		return array(
			'title' => 'Preview', 
			'version' => '2.04', 
			'summary' => 'Let you see a preview of a page.',
			'singular' => true, 
			'autoload' => true 
		);
	}

	public function init() {
		parent::init();
		$this->addHook('ProcessPageEdit::buildForm', $this, 'addButton');
		$this->addHook('ProcessPageEdit::execute', $this, 'addButtonJavascript');
		$this->addHook('ProcessPageView::execute', $this, 'changeView');
	}


	public function changeView(HookEvent $event) {
		$page = $this->pages->get((int) $_POST['id']);

		if(!($page instanceof NullPage)) {
			if(!$page->editable()) return;
			foreach($_POST as $key => $value) {
				if($page->fields->has($key)) $page->setFieldValue($key, $value);
			}
			$page->status = Page::statusOn;

			$this->pages->setOutputFormatting(true);
			$return = $page->setOutputFormatting(true)->render();
			$page->setOutputFormatting(false);
			$this->pages->setOutputFormatting(false);

			$event->return = $return;
		}
	}


	public function addButton(HookEvent $event) {
		$this->config->styles->add($this->config->urls->ProcessPreview.'ProcessPreview.css');

		$field = $this->modules->get('InputfieldSubmit');
		$field->attr('id+name', 'preview'); 
		$field->attr('class', $field->class); 
		$field->attr('value', 'Preview'); 

		$event->return = $event->return->append($field); 
	}

	public function addButtonJavascript(HookEvent $event) {
		$page = $this->pages->get($_GET['id']);
		$js = '<script type="text/javascript">
		var preview = false;
		$("#wrap_preview").click(function() {
			preview = true;
		});

		$("#ProcessPageEdit").submit(function() {
			if(preview == true) {
				tinyMCE.triggerSave();
				var ser = $(this).serialize();
				alert(ser);
				$.post("'.$page->url.'", ser,
					function(data) {
						var win = window.open("about:blank", "Preview");
						with(win.document) {
						  open();
						  write(data);
						  close();
						}
						preview = false;
						$("#preview").removeClass("ui-state-active");
					}
				);
				return false;
			}
		});

		</script>';
		$event->return = $event->return.$js;
	}
}
